<div class="head">
  <h1>Welcome, {{ userid }}, here are your activity records</h1>
</div>

<div class="container mt-4" *ngIf="report">
  <ng-container *ngIf="role === 'ADMIN'; else managerView">
    <!-- Admin View -->

    <!-- ✅ FIRST ROW: Products Added -->
    <div class="first-row">
      <div class="card" *ngIf="report.prodsAdded?.length">
        <ng-container *ngTemplateOutlet="cardTable; context: {
          title: 'Products Added',
          data: report.prodsAdded,
          columns: ['id', 'name', 'description', 'price'],
          key: 'prodsAdded'
        }"></ng-container>
      </div>
    </div>

    <!-- ✅ SECOND ROW: Stock + Product Updates -->
    <div class="second-row">
      <div class="card" *ngIf="report.stockUpds?.length">
        <ng-container *ngTemplateOutlet="cardTable; context: {
          title: 'Stock Updates',
          data: report.stockUpds,
          columns: ['inventoryId', 'oldStock', 'newStock'],
          key: 'stockUpds'
        }"></ng-container>
      </div>

      <div class="card" *ngIf="report.prodUpds?.length">
        <ng-container *ngTemplateOutlet="cardTable; context: {
          title: 'Product Updates',
          data: report.prodUpds,
          columns: ['productId', 'fieldUpdated', 'newValue'],
          key: 'prodUpds'
        }"></ng-container>
      </div>
    </div>

    <!-- ✅ THIRD ROW: Categories + Managers -->
    <div class="third-row">
      <div class="card" *ngIf="report.categadds?.length">
        <ng-container *ngTemplateOutlet="cardTable; context: {
          title: 'Categories Added',
          data: report.categadds,
          columns: ['id', 'categoryName'],
          key: 'categadds'
        }"></ng-container>
      </div>

      <div class="card" *ngIf="report.managers?.length">
        <ng-container *ngTemplateOutlet="cardTable; context: {
          title: 'Managers Created',
          data: report.managers,
          columns: ['id', 'name', 'email'],
          key: 'managers'
        }"></ng-container>
      </div>
    </div>
  </ng-container>

  <!-- Manager View (Updated) -->
<ng-template #managerView>
  <!-- ✅ FIRST ROW: Products Added -->
  <div class="manager-first-row">
    <div class="card" *ngIf="report.productAdded?.length">
      <ng-container *ngTemplateOutlet="cardTable; context: {
        title: 'Products Added',
        data: report.productAdded,
        columns: ['id', 'name', 'description', 'price'],
        key: 'productAdded',
        pageSize: 3
      }"></ng-container>
    </div>
  </div>

  <!-- ✅ SECOND ROW: Stock + Product Updates -->
  <div class="second-row">
    <div class="card" *ngIf="report.stockUpds?.length">
      <ng-container *ngTemplateOutlet="cardTable; context: {
        title: 'Stock Updates',
        data: report.stockUpds,
        columns: ['inventoryId', 'oldStock', 'newStock'],
        key: 'stockUpds'
      }"></ng-container>
    </div>

    <div class="card" *ngIf="report.prodUpds?.length">
      <ng-container *ngTemplateOutlet="cardTable; context: {
        title: 'Product Updates',
        data: report.prodUpds,
        columns: ['productId', 'fieldUpdated', 'newValue'],
        key: 'prodUpds'
      }"></ng-container>
    </div>
  </div>

  <!-- ✅ THIRD ROW: Category Requests -->
  <div class="manager-third-row">
    <div class="card" *ngIf="report.allRequest?.length">
      <ng-container *ngTemplateOutlet="cardTable; context: {
        title: 'Categories Requested',
        data: report.allRequest,
        columns: ['categoryName'],
        key: 'allRequest'
      }"></ng-container>
    </div>
  </div>
</ng-template>

</div>

<!-- Reusable Card Table Template -->
<ng-template #cardTable let-title="title" let-data="data" let-columns="columns" let-key="key" let-pageSize="pageSize">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">{{ title }}</h5>
      <input type="text"
             [(ngModel)]="filterQueries[key]"
             placeholder="Filter..."
             class="form-control form-control-sm w-50 ms-2" />
    </div>

    <div class="card-body p-2">
      <div>
        <table class="table table-sm table-bordered table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th *ngFor="let col of columns" class="text-capitalize">{{ col }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of getFilteredAndPaginatedData(key, data, pageSize || 5)">
              <td *ngFor="let col of columns">{{ row[col] }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav *ngIf="getTotalPages(getFilteredData(key, data), pageSize || 5) > 1">
        <ul class="pagination pagination-sm justify-content-center mt-2">
          <li class="page-item" [class.disabled]="getPage(key) === 1">
            <button class="page-link" (click)="setPage(key, getPage(key) - 1)" [disabled]="getPage(key) === 1">&laquo;</button>
          </li>

          <li class="page-item"
              *ngFor="let p of [].constructor(getTotalPages(getFilteredData(key, data), pageSize || 5)); let i = index"
              [class.active]="getPage(key) === i + 1">
            <button class="page-link" (click)="setPage(key, i + 1)">{{ i + 1 }}</button>
          </li>

          <li class="page-item" [class.disabled]="getPage(key) === getTotalPages(getFilteredData(key, data), pageSize || 5)">
            <button class="page-link" (click)="setPage(key, getPage(key) + 1)"
              [disabled]="getPage(key) === getTotalPages(getFilteredData(key, data), pageSize || 5)">&raquo;</button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</ng-template>
